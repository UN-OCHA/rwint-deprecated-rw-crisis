# ReliefWeb Crisis Page

The ReliefWeb Crisis Page is a single-page, responsive website intended to
provide a high-level overview of a complex, often multi-country crisis.

## Key Concepts

* The Crisis Page is a static site built on browser technologies and uses
  client-side rendering.
* Most data is provided by APIs. Aside from lazy-loaded timeline data, API data
  is baked into the configuration files. Long term the configuration files may
  live elsewhere.
* Individual widgets are served from the [embed service](https://github.com/reliefweb/rw-embed).
  They are iframes on the Crisis Page.


## System Requirements

Apache or nginx. Should serve configuration files (at least) with CORS support.

The `env/` directory has per-environment breakdown of nginx configuration and Docker startup processes. These files are used as-is on Local-Docker, Dev/Stage and Production.

## Dependencies
The dependencies below are only needed to build the static site. Operation of the site only depends on a webserver.

* **bower**: Manages frontend dependencies. `npm install -g bower@1.3.2`
* **bundler**: Manages Ruby dependencies for the build process, such as compass. `gem install bundler`
* **npm** Node.js and the npm package manage for node dependencies.
* **grunt-cli**: The grunt command-line tool. Drives the build process. `npm install -g grunt-cli`

## Operational Tasks

### Install

    npm install

This process will also run `bundle install` and `bower install`.
Note that `bower_components/` is found inside the `src/` directory.

### Generate Docroot

Generate a release package in `dist/` that can be served by a webserver.

       grunt

The contents of dist/ can be exported elsewhere for hosting, they have no lasting
dependency on the rest of the project repository.

### Rebuilding Data

If the widgets are badly broken, it may be the result of broken or missing data.
To fix that, re-run the `grunt collector` task to re-generate the configuration
and restart the service.

### Other Operations

For an overview of other available options, run `grunt -h` from inside the project
directory.

For environment-specific operations, check out the [Jenkins Dashboard](https://568elmp01.blackmesh.com/jenkins/view/Crisis%20Page/).

# Development

## Local - Quickstart

To develop locally there are very minimal steps needed.

* Get the dependencies straightened out. Skip infrastructure like Apache.
* `git clone git@github.com:reliefweb/rw-crisis.git`
* `cd rw-crisis`
* `npm install`
* `cp config/example.config.json config/config.json`
* `grunt`
* `grunt serve`

Your browser will open to the page `http://0.0.0.0:9001`

## Local - Docker

* Ignore all dependencies.
* Set up [_devtools_vm](https://bitbucket.org/phase2tech/_devtools_vm)
* `git clone git@github.com:reliefweb/rw-crisis.git`
* `cd rw-crisis`
* `cp config/example.config.json config/config.json`
* `fig up`
* Direct your browser to `http://crisis.vm`.


## Configuration

The Crisis Page is baked from configuration the build process expects to find in
`rw-crisis:config/config.json`.
Check out the [example.config.json](https://github.com/reliefweb/rw-crisis/blob/master/config/example.config.json)
for a working configuration.

The configuration files are downloaded for use in client-side rendering. Widget-specific
configuration files are generated by the collector script and are pulled in via
Embed service for each widget.

### Configuration Schema

In this section we'll explore the main configuration schema.

* **page-title**: The title of the page for the HTML HEAD and for the page heading.
* **meta**: An array of objects to be transformed into page meta-tags.
* **environment**: URLs that will vary by Crisis page environment.
  * **baseUrl**: The location of the Crisis Page instance.
  * **sources**: Object whose keys are arbitrary identifiers of API sources,
    values are their API root URLs. This allows any API requests elsewhere to be
    adaptive to target environment variations in the upstream APIs.
  * **keys**: Similar to *sources*, this is a kvp object for access keys.
    Configuring `google-analytics` here will automatically add the tracking code
    to the page.
* **widgets**: An array of widgets, each defined as an object with the following keys:
  * **slug**: A unique ID for the widget on the page. This is used as an HTML
    attribute, filename, and URL.
  * **title**: Title of the widget for display in navigation menu. It is not used
    as the widget title as that comes from the widget itself.
  * **config**: Contains widget-specific JSON configuration. In our examples you
    see a `url` key, if present this cues the Beat-Blocks library to use the
    contents of that URL for the widget configuration. A mix of both may be used.

### More Configuration Examples
* [Syria/Iraq Crisis (Development)](https://gist.github.com/grayside/f2116cef764c67df894e)
* [Syria/Iraq Crisis (Staging)](https://gist.github.com/grayside/6c18820b285a87b53c50)
* [Syria/Iraq Crisis (Production)](https://gist.github.com/grayside/3aac1341767165454248)

## New Crisis Page Instances

In order to create a new Crisis Page, you will need the following:

* Create a new configuration file. We maintain the canonical config files as gists.
* Adjust the order or selection of widgets by how the `widgets` configuration is set up.
* The slug is used to select the widget by assembling the Embed Service URL for the iframe source.
* Check out [rw-widget.js](https://github.com/reliefweb/rw-widget.js) for details
  on creating new widget types, and [Embed Service](https://github.com/reliefweb/rw-embed)
  for details on making them available for use.
* In order to customize the page beyond configuration, it is necessary to create
  a branch in the repo to track code changes.

## Collector/Baking Process

The configuration & data for each widget is assembled via a "baking" process by the
collector script. The collector script could easily live in it's own repository,
but for convenience it is built into the Crisis Page. In practice we expect to
evolve the Embed Service to handle collection and caching of data, rather than
relying on the Crisis Page baking process to pull and store the data.

The collector script can be run completely separate from grunt using
`bin/collect`, itself a convenience wrapper around `node collector/index.js`.

This triggers a node script that processes the main configuration file and all
remote widget configuration files looking for specially structured blocks of
configuration that indicate a remote API call should be made.

### Source Configuration

The main configuration file must provide the sources config as described above.

```js
{
  environment: {
    sources: {
      hdx: "http://data.hdx.rwlabs.org/api",
      fts: "http://fts.unocha.org/api",
      reliefweb: "http://api.rwlabs.org"
    }
  }
}
```

Then, when an part of the page or widget configuration contains an object with a
property `{ "type": "request" }`, that object will be processed by the collector
script to inline a content element with data from the data source. Let's examine
the full configuration of a request object.

* **source**: The key of one of the sources.
* **method**: The HTTP method for the request. Defaults to `GET`
* **path**: The path to the specific API resource. Appended to the source URL.
* **payload**: Payload for requests, such as advanced ReliefWeb API parameters.
* **selector**: A [JSONPath](https://github.com/dchester/jsonpath) selector to
  post-process the response before inserting back into the configuration.
* **fallback**: The default content to use in the event the API request fails.
  This is only used if no previous configuration processing was successful or the
  config files available for use.

#### Example Collector Configuration

Here is an example taken by stripping down one of the queries for the Syria/Iraq Crisis river widget.

```js
{
   "data": {
        "type": "request",
        "source": "reliefweb",
        "method": "POST",
        "path": "v1/reports?limit=4&fields[include][0]=source&fields[include][1]=date.created&fields[include][2]=url",
        "payload": {
            "filter": {
                "field": "country",
                "value": [
                  "Iraq",
                  "Syria"
                ]
            },
            "sort": [ "date.created:desc" ]
        }
   }
}
```

#### Example After Processing

```js
{
   "data": {
        "type": "request",
        "source": "reliefweb",
        "method": "POST",
        "path": "v1/reports?limit=4&fields[include][0]=source&fields[include][1]=date.created&fields[include][2]=url",
        "payload": {
            "filter": {
                "field": "country",
                "value": [
                  "Iraq",
                  "Syria"
                ]
            },
            "sort": [ "date.created:desc" ]
        }
        "content": {
          // ReliefWeb API Response
        }
        "date": {
          "checked": "2015-04-08T22:59:20.203Z",
          "updated": "2015-04-08T22:59:20.203Z"
        }
   }
}
```
